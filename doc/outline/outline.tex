% !TEX encoding = UTF-8
% !TEX program = pdflatex
\documentclass[a4paper]{article}
\usepackage[a4paper,top=3cm,bottom=4cm,left=3.8cm,right=3.8cm]{geometry}
\usepackage[T1]{fontenc}
\usepackage[utf8]{inputenc}
\usepackage[english]{babel}
\usepackage{graphicx}
\usepackage{wrapfig}
\usepackage{comment}
\usepackage{amsmath}
\usepackage{amsfonts}
\usepackage{amsthm}
\usepackage{enumerate}
\usepackage{enumitem}
\usepackage{physics}
\usepackage{bm}
  
%\theoremstyle{definition}  
\newtheorem*{defn}{Definition}  
\newtheorem*{prop}{Proposition} 
\newtheorem*{oss}{Observation}
\newtheorem {prob}{Problem}


\SetLabelAlign{Center}{\hfil#1\hfil}

\newenvironment{rcases}
{\left.\begin{aligned}}
	{\end{aligned}\right\rbrace}

\begin{document}
\title{NAPDE project outline}
\author{Matteo Calaf√† and Federica Botta}
\maketitle
\vspace{20mm}
\tableofcontents
\newpage


\section{Monodomain}
\vspace{5mm}
\subsection{Analytical models}
\vspace{5mm}
\paragraph{Monodomain model}
	\begin{equation}
	\begin{cases}
	\chi_m C_m\pdv{V_m}{t} - \nabla \cdot (\Sigma \nabla V_m) + \chi_m I_{ion}(V_m,w) = I^{ext}    & \text{in } \Omega_{mus} \cross (0,T]
	\\
	\pdv{w}{t} = g(V_m, w)  & \text{in } \Omega_{mus} \cross (0,T]
	\\
	\Sigma\nabla V_m \cdot n = b   & \text{on } \partial \Omega_{mus} \cross (0,T]
	\end{cases}
	\end{equation}
	\vspace{4mm}\newline
	where the unknowns are:
	\begin{itemize}
		\item $V_m$ = $\Phi_i - \Phi_e$ (difference between internal and external potential)
		\item $w$  ("\emph{gating variable}")
	\end{itemize}
    and these constants are given : $\chi_m, C_m, \Sigma$



\paragraph{FitzHugh-Nagumo model}
\begin{equation}
\begin{gathered}
I_{ion}(V_m, w) = -kV_m(V_m-a)(V_m-1) -w
\\
g(V_m,w) = \epsilon(V_m -\gamma w)
\end{gathered}
\end{equation}

\vspace{5mm}

\subsection{Semi-discretized numerical method}

	\vspace{5mm}
	 \begin{equation}
	 \begin{rcases}
	 V_{ij} &= \int_{\Omega}\nabla\varphi_j \cdot \nabla \varphi_i 
	 \\ I_{i,j}^T &= \sum_{F \in F_h^I} \int_{F} \{\{\nabla\varphi_j\}\} \cdot [[\varphi_i]] 
	\\ I_{i,j} &= \sum_{F \in F_h^I} \int_{F} [[\varphi_j]] \cdot \{\{\nabla \varphi_i\}\}
	 \\S_{i,j} &= \sum_{F \in F_h^I} \int_{F} \gamma [[\varphi_j]] \cdot [[\varphi_i]]]
	 \end{rcases}
	 \quad A = \Sigma(V -I^T - \delta I + S)
	\end{equation}
	\begin{equation}
	M_{ij} = \sum_{K \in \tau_h}\int_K
	\varphi_j\varphi_i
	\end{equation}
	\begin{equation}
	C(u_h)_{ij} = - \sum_{K \in \tau_h} \int_K \chi_m k(u_h-1)(u_h-a)\varphi_j\varphi_i
	\end{equation}
	\begin{equation}
	F_i = \int_{\Omega} f\varphi_i - \sum_{F \in F_h^B} \int_F b\varphi_i
	\end{equation}
	
	\vspace{3mm}
\paragraph{Semi-discretized problem} 

\begin{equation*}
\begin{gathered}
\{\varphi_j\}_{j=1}^{N_h} \text{ base di } V_h^p = \{v_h \in L^2 : v_h|_K \in \mathbb{P}^{p_k}(K) \quad p_k \leq p \quad \forall K \in \tau_h \}
\\
u_h(t) = \sum_{j=1}^{N_h} u_j(t)\varphi_j, \quad w_h(t) = \sum_{j=1}^{N_h}w_j(t)\varphi_j
\end{gathered}
\end{equation*}
\vspace{3mm}
\begin{equation}
\Rightarrow \quad  \begin{gathered}\boxed{\chi_mC_m M \dot{u} +  A u + C(u_h) u -\chi_mMw=F}
	\\
	\boxed{\dot{w} = \epsilon(u-\gamma w)}
	\end{gathered}
\end{equation}
\vspace{5mm}
\subsection{Totally-discretized numerical method ("$\bm{\theta-method}$")}
\vspace{5mm}
\paragraph{Initial form $(\theta \in [0,1])$}
\begin{enumerate}
	\item
	\begin{equation}
	\begin{gathered}
	\chi_mC_m M \frac{u^{k+1}-u^k}{\Delta t} +  A \left(\theta u^{k+1} + (1-\theta)u^k \right) + C(u^k)\left(\theta u^{k+1} + (1-\theta)u^k \right) +
	\\ -\chi_mMw^{k+1}=\theta F^{k+1} + (1-\theta)F^k
	\end{gathered}
	\end{equation}
	\item
	\begin{equation}
	\frac{w^{k+1}- w^{k}}{\Delta t} = \epsilon(u^k-\gamma w^{k+1})
	\end{equation}
\end{enumerate}
\vspace{3mm}
\paragraph{Expanded form $(\theta \in [0,1])$}
\begin{enumerate}
	\item
	\begin{equation}
	\begin{gathered}
	\left[\chi_mC_mM+\theta \Delta t A + \theta \Delta t C(u^k) \right] \bm{u^{k+1}} = \theta\Delta t F^{k+1} + (1-\theta)\Delta tF^k +
	\\
	\left[\chi_mC_mM- (1-\theta)\Delta t A - (1-\theta)\Delta t C(u^k)\right] u^k +\chi_m\Delta t Mw^{k+1} 
	\end{gathered}
	\end{equation}
	\item
	\begin{equation}
	\left[1+ \epsilon \gamma \Delta t\right] \bm{w^{k+1}} = w^k + (\epsilon \Delta t) u^k
	\end{equation}
\end{enumerate}







\newpage

\section{Bidomain}
\vspace{5mm}
\subsection{Analytical models}
\vspace{5mm}
\paragraph{Bidomain model}
\begin{equation}
\begin{cases}
\chi_m C_m\pdv{V_m}{t} - \nabla \cdot (\Sigma_i \nabla \phi_i) + \chi_m I_{ion}(V_m,w) = I_i^{ext}    & \text{in } \Omega_{mus} \cross (0,T]
\\
-\chi_m C_m\pdv{V_m}{t} - \nabla \cdot (\Sigma_e \nabla \phi_e) - \chi_m I_{ion}(V_m,w) = -I_e^{ext}    & \text{in } \Omega_{mus} \cross (0,T]
\\
\pdv{w}{t} = g(V_m, w)  & \text{in } \Omega_{mus} \cross (0,T]
\\
\Sigma_i\nabla \phi_i \cdot n = b_i   & \text{on } \partial \Omega_{mus} \cross (0,T]
\\
\Sigma_e\nabla \phi_e \cdot n = b_e   & \text{on } \partial \Omega_{mus} \cross (0,T]
\end{cases}
\end{equation}
\vspace{4mm}\newline
where the unknowns are:
\begin{itemize}
	\item $\phi_i, \phi_e$  $\quad (V_m = \phi_i-\phi_e$)
	\item $w$  ("\emph{gating variable}")
\end{itemize}
and these constants are given: $\chi_m, C_m, \Sigma_i, \Sigma_e$

\paragraph{FitzHugh-Nagumo model}
\begin{equation}
\begin{gathered}
I_{ion}(V_m, w) = -kV_m(V_m-a)(V_m-1) -w
\\
g(V_m,w) = \epsilon(V_m -\gamma w)
\end{gathered}
\end{equation}

\vspace{5mm}

\subsection{Semi-discretized numerical methods}

\vspace{5mm}
\begin{equation}
\begin{rcases}
V_{ij} &= \int_{\Omega}\nabla\varphi_j \cdot \nabla \varphi_i 
\\ I_{i,j}^T &= \sum_{F \in F_h^I} \int_{F} \{\{\nabla\varphi_j\}\} \cdot [[\varphi_i]] 
\\ I_{i,j} &= \sum_{F \in F_h^I} \int_{F} [[\varphi_j]] \cdot \{\{\nabla \varphi_i\}\}
\\S_{i,j} &= \sum_{F \in F_h^I} \int_{F} \gamma [[\varphi_j]] \cdot [[\varphi_i]]]
\end{rcases}
\begin{gathered}
\quad A = (V -I^T - \theta I + S)\\
\quad A_i = \Sigma_iA \\
\quad A_e = \Sigma_eA
\end{gathered}
\end{equation}
\begin{equation}
M_{ij} = \sum_{K \in \tau_h}\int_K
\varphi_j\varphi_i
\end{equation}
\begin{equation}
C(u_h)_{ij} = - \sum_{K \in \tau_h} \int_K \chi_m k(u_h-1)(u_h-a)\varphi_j\varphi_i
\end{equation}
\begin{equation}
\begin{gathered}
F_{i,k} = \int_{\Omega} I_i^{ext}\varphi_k - \sum_{F \in F_h^B} \int_F b_i\varphi_k
\\
F_{e,k} = - \int_{\Omega} I_e^{ext}\varphi_k - \sum_{F \in F_h^B} \int_F b_e\varphi_k
\end{gathered}
\end{equation}


	\vspace{3mm}
\paragraph{Semi-discretized problem} 

\begin{equation*}
\begin{gathered}
\{\varphi_j\}_{j=1}^{N_h} \text{ base di } V_h^k = \{v_h \in L^2 : v_h|_\mathcal{K} \in \mathbb{P}^{k}(\mathcal{K})  \quad \forall \mathcal{K} \in \tau_h \}
\\
\Phi_h(t) = \begin{bmatrix} \Phi_i^h(t) \\ \Phi_e^h(t) \end{bmatrix} = \begin {bmatrix}\sum_{j=1}^{N_h} \Phi_{i,j}(t)\varphi_j \\ \sum_{j=1}^{N_h} \Phi_{e,j}(t)\varphi_j \end{bmatrix},
 \quad w_h(t) = \sum_{j=1}^{N_h}w_j(t)\varphi_j
\end{gathered}
\end{equation*}
\vspace{3mm}
\begin{equation}\label{ref5}
\Rightarrow \quad
\boxed{
\begin{gathered}
 \chi_mC_m \begin{bmatrix}M &-M \\ -M & M \end{bmatrix}
	\begin{bmatrix}\bm{\dot{\Phi}_i^h(t)} \\ \bm{\dot{\Phi}_e^h(t)} \end{bmatrix}
	 + \begin{bmatrix}A_i & 0 \\ 0 & A_e \end{bmatrix}
	 \begin{bmatrix}\bm{\Phi_i^h(t)} \\ \bm{\Phi_e^h(t)} \end{bmatrix} +\\
	   \begin{bmatrix}C(V_m^h) & -C(V_m^h) \\ -C(V_m^h) & C(V_m^h) \end{bmatrix} 
	   \begin{bmatrix} \bm{\Phi_i^h(t)} \\ \bm{\Phi_e^h(t)}  \end{bmatrix} 
	   -\chi_m \begin{bmatrix}M & 0 \\ 0 & -M \end{bmatrix} 
	   	\begin{bmatrix}w_h(t) \\ w_h(t) \end{bmatrix} = 
	   	\begin{bmatrix} F_i^h \\ F_e^h\end{bmatrix}
\end{gathered}
}
\end{equation}
\begin{equation}
\boxed{\dot{w}_h(t) = \epsilon(V_m^h(t) - \gamma w_h(t))}
\end{equation}
\vspace{5mm}

\subsection{Totally-discretized numerical methods}
\vspace{4mm}
\subsubsection{Semi-implicit method}
\paragraph{Initial form}
\begin{equation}
\begin{gathered}
\chi_mC_m \begin{bmatrix}M &-M \\ -M & M \end{bmatrix}
\begin{bmatrix}\frac{\Phi_i^{k+1}-\Phi_i^k}{\Delta t} \\ \frac{\Phi_e^{k+1}-\Phi_e^k}{\Delta t} \end{bmatrix}
+ \begin{bmatrix}A_i & 0 \\ 0 & A_e \end{bmatrix}
\begin{bmatrix}\Phi_i^{k+1} \\ \Phi_e^{k+1} \end{bmatrix} + \\
 \begin{bmatrix}C(V_m^k) & -C(V_m^k) \\ -C(V_m^k) & C(V_m^k) \end{bmatrix} 
\begin{bmatrix} \Phi_i^{k+1} \\ \Phi_e^{k+1}  \end{bmatrix} 
-\chi_m \begin{bmatrix}M & 0 \\ 0 & -M \end{bmatrix} 
\begin{bmatrix}w^{k+1} \\ w^{k+1} \end{bmatrix} = 
\begin{bmatrix} F_i^{k+1} \\ F_e^{k+1}\end{bmatrix}
\end{gathered}
\end{equation}
\vspace{5mm}
\begin{equation}
\frac{w^{k+1}-w^k}{\Delta t} = \epsilon (V_m^k - \gamma w^{k+1})
\end{equation}

\paragraph{Expanded form}
\begin{equation}
\begin{gathered}
\left( \frac{\chi_m C_m}{\Delta t} \begin{bmatrix} M & -M \\ -M & M \end{bmatrix} + \begin{bmatrix} A_i & 0 \\ 0 & A_e \end{bmatrix} + 
\begin{bmatrix}
C(V_m^k) & -C(V_m^k) \\ -C(V_m^k) & C(V_m^k)
\end{bmatrix}\right)
\begin{bmatrix} \bm{\Phi_i^{k+1}} \\ \bm{\Phi_e^{k+1}} \end{bmatrix} = 
\\
\begin{bmatrix} F_i^{k+1} \\ F_e^{k+1} \end{bmatrix} 
+ \chi_m \begin{bmatrix}M & 0 \\ 0 & -M \end{bmatrix}
\begin{bmatrix} w^{k+1} \\ w^{k+1} \end{bmatrix}
+ \frac{\chi_m C_m}{\Delta t} \begin{bmatrix}M & -M \\ -M & M\end{bmatrix}
\begin{bmatrix} \Phi_i^{k} \\ \Phi_e^{k} \end{bmatrix}
\end{gathered}
\end{equation}

\vspace{5mm}
\begin{equation}
(1+\epsilon \gamma \Delta t)w^{k+1} = w^k + \epsilon \Delta t V_m^k
\end{equation}

\newpage
\subsubsection{Quasi-implicit Operator Splitting}
\paragraph{Initial form}
\begin{enumerate}[label = \Roman*, align = Center]
	\item 
	\begin{equation}
	\begin{gathered}
	\chi_m C_m M \frac{\tilde{V}_m^{n+1}-V_m^n}{\Delta t} +  C(V_m^n) V_m^{n+1} - \chi_m M w^{n+1}= 0
	\\
	 \frac{w^{n+1} - w^n}{\Delta t} = \epsilon (V_m^{n+1}-\gamma w^{n+1})
	\end{gathered}
	\end{equation}
	\item 
	\begin{equation}
	\begin{gathered}
	\chi_m C_m M \frac{V_m^{n+1}-\tilde{V}_m^{n+1}}{\Delta t} + A_i \Phi_i^{n+1}= F_i^{n+1}
	\\
	- \chi_m C_m M \frac{V_m^{n+1}-\tilde{V}_m^{n+1}}{\Delta t} + A_e \Phi_e^{n+1}= F_e^{n+1}
	\end{gathered}
	\end{equation}
	
\end{enumerate}
\vspace{5mm}
\paragraph{Expanded form}
\begin{equation}
\vspace{5mm}
\begin{cases}
\chi_m C_m M \frac{V_m^{n+1}-V_m^{n}}{\Delta t} + C(V_m^n) V_m^{n+1} - \chi_m M w^{n+1} + A_i \Phi_i ^{n+1} = F_i^{n+1} \\
\chi_m C_m M \frac{V_m^{n+1}-V_m^{n}}{\Delta t} +  C(V_m^n) V_m^{n+1} - \chi_m M w^{n+1} - A_e \Phi_e ^{n+1} =  -F_e^{n+1} \\
\frac{w^{n+1}-w^{n}}{\Delta t} = \epsilon(V_m^{n+1}-\gamma w^{n+1})
\end{cases}
\end{equation}

 \begin{equation}
 \begin{gathered}
 \begin{aligned}
 & \bullet \quad Q_n := \frac{\chi_m C_m}{\Delta t}M + C(V_m^n) - \frac{\epsilon\chi_m \Delta t}{1 + \epsilon \gamma \Delta t} M \\
 & \bullet \quad R_n := \frac{\chi_mC_m}{\Delta t}MV_m^n + \frac{\chi_m}{1+\epsilon\gamma\Delta t}M w^n
 \end{aligned}
 \end{gathered}
\end{equation}

\vspace{5mm}
\begin{enumerate}
	\item 
	\begin{equation}
	\begin{gathered}
	\chi_m C_m M \frac{	\Phi_i^{n+1}-\Phi_e^{n+1}-V_m^{n}}{\Delta t} +  C(V_m^n) (\Phi_i^{n+1}-\Phi_e^{n+1}) + \\ - \chi_m M \left(\frac{w^n + \epsilon \Delta t (\Phi_i^{n+1}-\Phi_e^{n+1})}{1+\epsilon \gamma \Delta t}   \right) + A_i \Phi_i ^{n+1} = F_i^{n+1} \\ \\
     \Rightarrow \quad (Q_n + A_i) \Phi_i^{n+1} - Q_n \Phi_e^{n+1} =R_n +  F_i^{n+1}
	\end{gathered}
	\end{equation}
	
    \item 
	\begin{equation}
	\begin{gathered}
	\chi_m C_m M \frac{	\Phi_i^{n+1}-\Phi_e^{n+1}-V_m^{n}}{\Delta t} + \cdot C(V_m^n) (\Phi_i^{n+1}-\Phi_e^{n+1}) + \\ -  \chi_m M \left(\frac{w^n + \epsilon \Delta t (\Phi_i^{n+1}-\Phi_e^{n+1})}{1+\epsilon \gamma \Delta t}   \right) - A_e \Phi_e ^{n+1} = -F_e^{n+1} \\ \\
	\Rightarrow \quad Q_n \Phi_i^{n+1} - (Q_n+A_e) \Phi_e^{n+1} =R_n - F_e^{n+1}
	\end{gathered}
	\end{equation}
	\vspace{3mm}
	\item 
	\begin{equation}
	w^{n+1} = \frac{w^n + \epsilon \Delta t (\Phi_i^{n+1}-\Phi_e^{n+1})}{1+\epsilon \gamma \Delta t}
	\end{equation}
\end{enumerate}


\begin{equation}
\Rightarrow \quad
\begin{cases}
\left(
\begin{bmatrix} Q_n & -Q_n \\ Q_n & -Q_n \end{bmatrix} + 
\begin{bmatrix} A_i & 0 \\ 0 & -A_e\end{bmatrix}
\right)
\begin{bmatrix}
\bm{\Phi_i^{n+1}} \\ \bm{\Phi_e^{n+1}}
\end{bmatrix}
= \begin{bmatrix} R_n \\ R_n \end{bmatrix} + \begin{bmatrix} F_i^{n+1} \\  -F_e^{n+1}\end{bmatrix} \\ \\
Q_n = \frac{\displaystyle \chi_m C_m}{\displaystyle \Delta t}M +  \cdot C(V_m^n) - \frac{\displaystyle \epsilon\chi_m \Delta t}{\displaystyle 1 + \epsilon \gamma \Delta t}M \\ \\
R_n := \frac{\displaystyle \chi_mC_m}{\displaystyle \Delta t}MV_m^n + \frac{\displaystyle \chi_m}{\displaystyle 1+\epsilon\gamma\Delta t}M w^n \\ \\
w^{n+1} = \frac{\displaystyle w^n + \epsilon \Delta t (\Phi_i^{n+1}-\Phi_e^{n+1})}{\displaystyle 1+\epsilon \gamma \Delta t}
\end{cases}
\end{equation}


\vspace{5mm}
\subsubsection{Godunov Operator Splitting}
\paragraph{Initial form}
\begin{enumerate}[label = \Roman*, align = Center]
\item 
   \begin{equation}
   \begin{gathered}
   \chi_m C_m M\frac{\hat{V}_m^{n+1} - V_m^n}{\Delta t} + C(V_m^n)V_m^n -\chi_mMw^n = 0
   \\
   \frac{w^{n+1}-w^n}{\Delta t} = \epsilon (V_m^n - \gamma w^n)
   \end{gathered}
   \end{equation}
\item 
   \begin{equation}
   \begin{gathered}
   \chi_m C_m M\frac{V_m^{n+1} - \hat{V}_m^{n+1}}{\Delta t} + A_i\Phi_i^{n+1} = F_i^{n+1} \\
   -\chi_m C_m M\frac{V_m^{n+1} - \hat{V}_m^{n+1}}{\Delta t} + A_e\Phi_e^{n+1} = F_e^{n+1}
   \end{gathered}
   \end{equation}
\end{enumerate}
\vspace{3mm}
\paragraph{Expanded form}

\begin{equation}
\begin{gathered}
\begin{cases}
\chi_m C_m M\frac{V_m^{n+1} - V_m^n}{\Delta t} + C(V_m^n)V_m^n -\chi_mMw^n + A_i \Phi_i^{n+1}= F_i^{n+1} \\
\chi_m C_m M\frac{V_m^{n+1} - V_m^n}{\Delta t} + C(V_m^n)V_m^n -\chi_mMw^n - A_e \Phi_e^{n+1}= -F_e^{n+1} \\
w^{n+1} = (1-\epsilon \gamma \Delta t) w^n + \epsilon \Delta t V_m^n
\end{cases}
\\ \\  
\Rightarrow
\begin{cases}
\left( \frac{\chi_m C_m}{\Delta t} M + A_i \right ) \Phi_i^{n+1} - \frac{\chi_m C_m}{\Delta t} M \Phi_e^{n+1} = F_i^{n+1} + \chi_m M w^n + \left( \frac{\chi_m C_m}{\Delta t} M- C(V_m^n)\right) V_m^n \\ 
\frac{\chi_m C_m}{\Delta t} M  \Phi_i^{n+1} - \left(\frac{\chi_m C_m}{\Delta t} M + A_e \right) \Phi_e^{n+1} =  -F_e^{n+1} + \chi_m M w^n + \left( \frac{\chi_m C_m}{\Delta t} M- C(V_m^n)\right) V_m^n \\
w^{n+1} = (1-\epsilon \gamma \Delta t) w^n + \epsilon \Delta tV_m^n
\end{cases}
\end{gathered} 
\end{equation}
\vspace{3mm}
\begin{equation}
\Rightarrow \quad 
\begin{cases}
\begin{gathered}
\left(
	\frac{\chi_m C_m}{\Delta t} \begin{bmatrix}M & -M \\ M & -M\end{bmatrix}
	+ \begin{bmatrix} A_i & 0 \\ 0 & -A_e \end{bmatrix}
	\right) \begin{bmatrix} \bm{\Phi_i^{n+1}} \\ \bm{\Phi_e^{n+1}}  \end{bmatrix} =
	\begin{bmatrix} F_i^{n+1} \\ -F_e^{n+1} \end{bmatrix} + \\
	\chi_m\begin{bmatrix} M & 0 \\ 0 & M \end{bmatrix} \begin{bmatrix} w^n \\ w^n \end{bmatrix} +
	\left(\frac{\chi_mC_m}{\Delta t}\begin{bmatrix} M & 0 \\ 0 & M \end{bmatrix}
	- \begin{bmatrix} C(V_m^n) & 0 \\ 0 & C(V_m^n)\end{bmatrix} 
	\right) \begin{bmatrix} V_m^n \\ V_m^n \end {bmatrix}
	 \end{gathered} \\ \\
	w^{n+1} = (1-\epsilon \gamma \Delta t) w^n + \epsilon \Delta tV_m^n
\end{cases}
\end{equation}





\newpage
\section{Dubiner basis} 
\vspace{5mm}
\subsection{Basis functions}
\vspace{4mm}
\subsubsection{Mapping transformation}
	On the reference triangle
	\begin{equation}
	\hat{K}=\{ (\xi, \eta) : \xi, \eta \ge 0,	\xi+\eta \le 1 \}
	\end{equation}
	we consider the transformation between the reference square and the reference triangle given by
	\begin{equation}
	\xi:=\frac{(1+a)(1-b)}{4},  \eta:=\frac{(1+b)}{2}
	\end{equation}
	and the inverse transformation is
	\begin{equation}
	a:=\frac{2\xi-1+\eta}{1-\eta}=\frac{2\xi}{1-\eta}-1,	b:=2\eta-1
	\end{equation}

\vspace{4mm}

\subsubsection{Jacobian polynomials}

Evaluation of the polynomial in $z\in \mathbb{R}^n$:
\begin{itemize}[label=\textendash]
\item $n=0$
\begin{equation}
J_0^{\alpha,\beta}(z)=\overbrace{\begin{bmatrix} 1 & 1 &\dots &1 \end{bmatrix}}^{\text{n times}}
\end{equation}
\item $n=1$
\begin{equation}
J_1^{\alpha,\beta}(z)=\frac{1}{2}(\alpha-\beta+(\alpha+\beta+2)\cdot z);
\end{equation}
\item $n\ge2$
\newline
\begin{equation}
\begin{gathered}
\begin{aligned}
J_n^{\alpha,\beta}(z)=\sum_{k=2}^{n} \Big[&\frac{(2k+\alpha+\beta-1)(\alpha^{2}-\beta^{2})}{2k(k+\alpha+\beta)(2k+\alpha+\beta-2)}+ \\ &\frac{(2k+\alpha+\beta-2)(2k+\alpha+\beta-1)(2k+\alpha+\beta)}{2k(k+\alpha+\beta)(2k+\alpha+\beta-2)} J_{k-1}^{\alpha,\beta}(z) +
\\-&\frac{2(k+\alpha-1)(k+\beta-1)(2k+\alpha+\beta)}{2k(k+\alpha+\beta)(2k+\alpha+\beta-2)} J_{k-2}^{\alpha,\beta}(z) \Big]
\end{aligned}
\end{gathered}
\end{equation}
\end{itemize}

\begin{prop}
	$J_i^{\alpha,\beta}(\cdot)$ is orthogonal w.r.t. the Jacobi weight $w(x)=(1-x)^\alpha(1+x)^\beta$:
	\begin{equation}  \label{ref2}
	\int_{-1}^{1}{(1-x)^\alpha(1+x)^\beta J_m^{\alpha,\beta} J_q^{\alpha,\beta}(x)dx}=\frac{2}{2m+1} \delta_{mq} 
	\end{equation}
\end{prop}

\vspace{4mm}

\subsubsection{Dubiner Basis}
\vspace{4mm}
	\begin{equation}
	\begin{split}
	\phi_{ij}(\xi,\eta) :&= c_{ij}(1-b)^j J_i^{0,0}(a) J_j^{2i+1,0}(b)=
	\\&=c_{ij} 2^j (1-\eta)^j J_i^{0,0}(\frac{2\xi}{1-\eta}-1) J_j^{2i+1,0} (2\eta-1)
	\end{split}
	\end{equation}
	for $i,j=1,\dots,p$ and $i+j \le p$, where
	\begin{equation}
	c_{ij} := \sqrt{\frac{2(2i+1)(i+j+1)}{4^i}}
	\end{equation}
	and $J_i^{\alpha,\beta}(\cdot)$ is the i-th Jacobi polynomial

\vspace{4mm}
\subsubsection{Gradient of Dubiner Basis}
    \begin{itemize}[label=\textendash]
	\item $i=0,j=0$
	\begin{equation}
	\begin{split}
	&\phi_{00}^{\xi}(\xi,\eta)=0
	\\&\phi_{00}^{\eta}(\xi,\eta)=0
	\end{split}
	\end{equation}
	\item $i=0,j\neq0$
	\begin{equation}
	\begin{split}
	&\phi_{0j}^{\xi}=0
	\\&\phi_{0j}^{\eta}=c_{0j} (j+2) J_{j-1}^{2,1}(b)
	\end{split}
	\end{equation}
	\item $i\neq0,j=0$
	\begin{equation}
	\begin{split}
	&\phi_{i0}^{\xi}(\xi,\eta)=c_{i0} 2^{i} (1-\eta)^{i-1} (i+1) J_{i-1}^{1,1}(a)
	\\&\phi_{i0}^{\eta}(\xi,\eta)=c_{i0} 2^{i} (-i(1-\eta)^{i-1} J_{i}^{0,0}(a)+\xi(1-\eta)^{i-2}(i+1) J_{i-1}^{1,1}(a))
	\end{split}
	\end{equation}
	\item $i\neq0,j\neq0$
	\begin{equation}
	\begin{split}
	&\phi_{ij}^{\xi}(\xi,\eta)=c_{ij} 2^{i} (1-\eta)^{i-1} (i+1) J_{i-1}^{1,1}(a) J_{j}^{2i+1,0}(b)
	\\&\phi_{ij}^{\eta}(\xi,\eta)=c_{ij} 2^{i} (-i(1-\eta)^{i-1} J_{i}^{0,0}(a) J_{j}^{2i+1,0}(b)+\xi(1-\eta)^{i-2}(i+1) J_{i-1}^{1,1}(a) J_{j}^{2i+1,0}(b)
	\\&+(1-\eta)^{i}(2i+j+2) J_{i}^{0,0}(a) J_{j-1}^{2i+2,1}(b))
	\end{split}
	\end{equation}
	\end{itemize}
\vspace{5mm}
\subsection{Transformation from FEM to Dubiner basis}
	One of the many advantages of the FEM basis is that the evaluation of a basis function in a point of the mesh is equal to 1 only if that point is the one associated to the basis, 0 otherwise:
	\begin{equation} \label{ref1}
	\psi_i(x_j)=\delta_{ij}
	\end{equation}
	This property cannot be satisfied by Dubiner basis (although other good properties hold in this case, for instance regularity and especially \emph{orthogonality}). Indeed these basis have not localized support and they are neither normalized on the mesh edges. This means that the coefficients of the solution of the Dubiner system are \emph{not} the evaluation over the mesh points of the discretized function itself. They have a completely different meaning, they are now \emph{modal} values instead of being \emph{nodal}.
	For this reason we introduced two new functions that best transform the coefficients of the solution w.r.t. FEM basis to the coefficients w.r.t. Dubiner basis and viceversa.\vspace{5mm}
	
	\noindent Consider an element $\mathcal{K}\in \tau_h$ and $\{\psi_{i}\}_{i=1}^{p}$,$\{\phi_{j}\}_{j=1}^{q}$ as, respectively, the set of FEM functions and the set of Dubiner functions with support in $\mathcal{K}$. In addition, consider as $\{\hat{u}_i\}_{i=1}^p$,$\{\tilde{u}_j\}_{j=1}^q$ as, respectively, the FEM and Dubiner coefficients of the solution. \vspace{5mm}
	
	\noindent Let us start from the transformation to the FEM coefficients. We now exploit the property \ref{ref1}, i.e. the coefficient $\hat{u}_i$ is nothing else but the evaluation of $u_h$ on the i-th mesh point, then: 
	\begin{equation} \label{ref3}
	\hat{u}_i = \sum_{j=1}^q \tilde{u}_j\phi_j(x_i)
	\end{equation}
	where $x_i$ is the point associated to the $\psi_i$ basis function. \vspace{5mm}
	
	\noindent Instead, to compute the coefficients conversely, we need to exploit the fact that the Dubiner Basis are $L^2$-orthonormal (property obtained thanks to \ref{ref2}). We then need to compute a $L^2$ scalar product between the FEM discretized function and each Dubiner basis function. That means:
	\begin{equation}\label{ref4}
	\tilde{u}_j = \int_\mathcal{K} u_h(x) \phi_j(x) \,dx = \int_{\mathcal{K}} \sum_{i=1}^p \hat{u}_i\psi_i(x) \phi_j(x) \,dx = \sum_{i=1}^p \Big(\int_{\mathcal{K}}\psi_i(x)\phi_j(x)\,dx \Big) \hat{u}_i
	\end{equation}
	
	\vspace{5mm}
	\noindent If the Dubiner functions are chosen as Galerkin basis, both the transformations are needed for the code implementation. Formula \ref{ref3} is needed to plot and compute errors after the resolution of the system (otherwise solely Dubiner coefficients are useless). Formula \ref{ref4} is instead needed to convert the FEM initial data $u_0$ into a vector of Dubiner coefficients before the resolution of the system.
	
	\vspace{5mm}
	\noindent For the sake of both simplicity and logic, we have decided to implement these transformations only from $P_n$ to $D_n$, $n=1,2,3$ and viceversa. Indeed, from one side, the degree of FEM is here less "important" since it contributes only to the number of points to which evaluate the computed solution. Then, increasing $n$ for P does not substantially improve the quality of the solution. On the other side, choosing the same degree for P and D means having the same number of local nodes ($nln$). For this reason, both $p$ and $q$ are replaced with $nln$ in the code.	
	
	
	\vspace{5mm}
	\noindent Finally, these are the coordinates of the evaluation points over the reference square:
	\begin{itemize}
	\item n=1
	\begin{equation*}
	\begin{split}
	a &= \begin{bmatrix} -1 & 1& -1\end{bmatrix}\\ b &= \begin{bmatrix} -1 &-1& 1\end{bmatrix}
	\end{split}
	\end{equation*} 
	
	\item n=2
	\begin{equation*}
	\begin{split}
	a &= \begin{bmatrix} 1 &0& 1 &1 &-1& -1\end{bmatrix} \\ b &= \begin{bmatrix}-1& -1& -1& 0& 1& 0\end{bmatrix}
	\end{split}
	\end{equation*} 
	
	\item n=3
	\begin{equation*}
	\begin{split}
	a &= \begin{bmatrix}-1& -0.5& 0.5& 1& 1& 1& -1& -1& -1& 0\end{bmatrix} \\ b&=\begin{bmatrix}-1& -1& -1& -1& -0.5& 0.5& 1& 0.5& -0.5& -1/3\end{bmatrix}
	\end{split}
	\end{equation*}
	\end{itemize}
	
\section{Few considerations about well-posedness}
All the previous Bidomain schemes treat the non-linear term in a semi-implicit way (see \ref{ref5}). It means that at time $t^{n+1}$ we can solve a linear problem if data at time $t^n$ are provided as parameters. From another perspective, at each time step $t^{n+1}$, we can fix the data of the previous time-step and solve a linear variational problem. In this case, the bilinear form at the left-hand side is the sum of some simpler bilinear forms: the standard mass $L^2$ inner product for the time derivative, the standard stiffness bilinear form and a pseudo-mass bilinear form for the non-linear term.

\begin{equation}
a_c(u,v) = -\int_\Omega \chi_mk(V_m^{n}-a)(V_m^{n}-1)uv \, dx
\end{equation}

\noindent We want to check that this bilinear form is coercive w.r.t $L^2(\Omega)$ (without considering the others for now). That means to check that:

\begin{equation}
\exists \, \alpha>0: a_c(u,u) \ge \alpha ||u||^2 \quad \forall u \in L^2(\Omega)
\end{equation}


Then:
\begin{equation}
a_c(u,u) = \int_\Omega -\chi_mk(V_m^{n}-a)(V_m^{n}-1)u^2 \, dx \ge \inf_{x \in \Omega} [-\chi_mk(V_m^{n}-a)(V_m^{n}-1)] ||u||_{L^2}^2
\end{equation}
\newline
Since all parameters are positive and $a\ll1$, $\alpha =\inf_{x \in \Omega} [-\chi_mk(V_m^{n}-a)(V_m^{n}-1)]$ is positive only if:\newline
\begin{equation}
(V_m^{n}-1)(V_m^{n}-a) < 0 \Leftrightarrow a<V_m^n < 1
\end{equation}
\newline
Finally, we can say that if the exact solution is between $a$ and 1, $a_c$ is coercive.\vspace{4mm}\newline
Obviously, this is only a sufficient condition for the total coercivity (remember that the other bilinear forms can contribute for the positiveness of $a(u,u)$). However, if this property fails, there may be bad consequences for the stability, especially in presence of physiological parameters.
For the first simulations, indeed, we considered the exact solution:
\begin{equation}
V_m(x,t)=sin(2 \pi x) sin(2 \pi y) e^{-5t}
\end{equation}
whose image is in [-1,1]. Choosing physiological parameters, we obtained some instabilities. 
Translating the exact solution, in order to replace the image into [0,1] (remember that $a$ is a small parameter), we found instead convergence:
\begin{equation}
V_m(x,t)=\frac{1}{2} sin(2 \pi x) sin(2 \pi y) e^{-5 t}+\frac{1}{2}
\end{equation}
\end{document}
